<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Fundamentals - Environments (dev, stage, prod) | Sudo's Notes</title>
    <meta charset="utf-8" />
    <meta http-equiv="content-type" content="text/html;" />
    <meta name="viewport" content="initial-scale=1.0 maximum-scale=1.0" />
    <meta property='og:image' content='https://thunguyen1012.github.io/img/default.jpg'><meta name='description' content=''>
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="google-site-verification"
      content="google-site-verification=kcDFRw1y16XjxYUB-datjB6MQB-CsjgE9h6lCalynC4"
    />

    <!-- Google Analytics -->
    <script>
      window.ga =
        window.ga ||
        function () {
          (ga.q = ga.q || []).push(arguments);
        };
      ga.l = +new Date();
      ga("create", "UA-120719369-1", "auto");
      ga("send", "pageview");
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    <!-- End Google Analytics -->
    <link href="../css/theme-dark.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../css/highlight/railscasts.css" />
    <script src="../js/highlight.pack.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const content = document.getElementsByClassName("main")[0];
        const currentURL = window.location.href;

        function updateReadPercentage() {
          const contentHeight = content.offsetHeight;
          const viewportHeight = window.innerHeight;
          const scrollY = window.scrollY;
          let readPercentage =
            ((scrollY + viewportHeight) / contentHeight) * 100;
          readPercentage = Math.min(100, Math.max(0, readPercentage));

          const storedData = localStorage.getItem("readPercentage");
          const readingItems = JSON.parse(storedData) || [];
          const item = readingItems.find((item) => item.url === currentURL);
          if (item) {
            item.percent = Math.floor(readPercentage);
          } else {
            readingItems.push({
              url: currentURL,
              percent: Math.floor(readPercentage),
            });
          }
          localStorage.setItem("readPercentage", JSON.stringify(readingItems));
        }

        function loadReadPercentage() {
          const storedData = localStorage.getItem("readPercentage");
          const readingItems = JSON.parse(storedData) || [];
          const item = readingItems.find((item) => item.url === currentURL);
          if (item) {
            const contentHeight = content.offsetHeight;
            const viewportHeight = window.innerHeight;
            const scrollPosition =
              (item.percent / 100) * contentHeight - viewportHeight;

            window.scrollTo(0, scrollPosition);
          }
        }

        window.addEventListener("scroll", updateReadPercentage);
        window.addEventListener("resize", updateReadPercentage);
        loadReadPercentage();
        updateReadPercentage();
      });
    </script>
  </head>
  <body>
    <div class="header">
      <a href="/"><span class="avatar"></span></a>
    </div>
    <div class="container">
      <div class="main">
        <h1>Fundamentals - Environments (dev, stage, prod)</h1>
        <h2><a href="#in-this-article" aria-hidden="true" class="anchor" id="in-this-article"></a>In this article</h2>
<h2><a href="#environments" aria-hidden="true" class="anchor" id="environments"></a>Environments</h2>
<ul>
<li>
<p><code>DOTNET_ENVIRONMENT</code></p>
</li>
<li>
<p><code>ASPNETCORE_ENVIRONMENT</code> when the <code>WebApplication.CreateBuilder</code> method is called. The default ASP.NET Core web app templates call <code>WebApplication.CreateBuilder</code>. The <code>DOTNET_ENVIRONMENT</code> value overrides <code>ASPNETCORE_ENVIRONMENT</code> when <code>WebApplicationBuilder</code> is used. For other hosts, such as <code>ConfigureWebHostDefaults</code> and <code>WebHost.CreateDefaultBuilder</code>, <code>ASPNETCORE_ENVIRONMENT</code> has higher precedence.</p>
</li>
<li>
<p><code>Development</code>: The <code>launchSettings.json</code> file sets <code>ASPNETCORE_ENVIRONMENT</code> to <code>Development</code> on the local machine.</p>
</li>
<li>
<p><code>Staging</code></p>
</li>
<li>
<p><code>Production</code>: The default if <code>DOTNET_ENVIRONMENT</code> and <code>ASPNETCORE_ENVIRONMENT</code> have not been set.</p>
</li>
<li>
<p>Is similar to the code generated by the ASP.NET Core templates.</p>
</li>
<li>
<p>Enables the Developer Exception Page when <code>ASPNETCORE_ENVIRONMENT</code> is set to <code>Development</code>. This is done automatically by the <code>WebApplication.CreateBuilder</code> method.</p>
</li>
<li>
<p>Calls UseExceptionHandler when the value of <code>ASPNETCORE_ENVIRONMENT</code> is anything other than <code>Development</code>.</p>
</li>
<li>
<p>Provides an IWebHostEnvironment instance in the Environment property of <code>WebApplication</code>.</p>
</li>
</ul>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler(&quot;/Error&quot;);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
</code></pre>
<pre><code class="language-cshtml">&lt;environment include=&quot;Development&quot;&gt;
    &lt;div&gt;Environment is Development&lt;/div&gt;
&lt;/environment&gt;
&lt;environment exclude=&quot;Development&quot;&gt;
    &lt;div&gt;Environment is NOT Development&lt;/div&gt;
&lt;/environment&gt;
&lt;environment include=&quot;Staging,Development,Staging_2&quot;&gt;
    &lt;div&gt;Environment is: Staging, Development or Staging_2&lt;/div&gt;
&lt;/environment&gt;
</code></pre>
<h3><a href="#create-environmentssample" aria-hidden="true" class="anchor" id="create-environmentssample"></a>Create <code>EnvironmentsSample</code></h3>
<pre><code class="language-bash">dotnet new webapp -o EnvironmentsSample
cd EnvironmentsSample
dotnet run --verbosity normal
</code></pre>
<pre><code class="language-bash">info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7152
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5105
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Path\To\EnvironmentsSample
</code></pre>
<h3><a href="#set-environment-on-the-command-line" aria-hidden="true" class="anchor" id="set-environment-on-the-command-line"></a>Set environment on the command line</h3>
<pre><code class="language-dotnetcli">dotnet run --environment Production
</code></pre>
<pre><code class="language-bash">info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7262
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5005
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Path\To\EnvironmentsSample
</code></pre>
<h3><a href="#development-and-launchsettingsjson" aria-hidden="true" class="anchor" id="development-and-launchsettingsjson"></a><code>Development</code> and <code>launchSettings.json</code></h3>
<ul>
<li>
<p>Is only used on the local development machine.</p>
</li>
<li>
<p>Is not deployed.</p>
</li>
<li>
<p>Contains profile settings.</p>
</li>
</ul>
<pre><code class="language-json">{
  &quot;iisSettings&quot;: {
    &quot;windowsAuthentication&quot;: false,
    &quot;anonymousAuthentication&quot;: true,
    &quot;iisExpress&quot;: {
      &quot;applicationUrl&quot;: &quot;http://localhost:59481&quot;,
      &quot;sslPort&quot;: 44308
    }
  },
  &quot;profiles&quot;: {
    &quot;EnvironmentsSample&quot;: {
      &quot;commandName&quot;: &quot;Project&quot;,
      &quot;dotnetRunMessages&quot;: true,
      &quot;launchBrowser&quot;: true,
      &quot;applicationUrl&quot;: &quot;https://localhost:7152;http://localhost:5105&quot;,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Development&quot;
      }
    },
    &quot;IIS Express&quot;: {
      &quot;commandName&quot;: &quot;IISExpress&quot;,
      &quot;launchBrowser&quot;: true,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Development&quot;
      }
    }
  }
}
</code></pre>
<ul>
<li>
<p><code>EnvironmentsSample</code>: The profile name is the project name. As the first profile listed, this profile is used by default. The &quot;commandName&quot; key has the value &quot;Project&quot;, therefore, the Kestrel web server is launched.</p>
</li>
<li>
<p><code>IIS Express</code>: The &quot;commandName&quot; key has the value &quot;IISExpress&quot;, therefore, <code>IISExpress</code> is the web server.</p>
</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/environments/_static/iisx2.png?view=aspnetcore-8.0" alt="IIS Express launch on menu!" title="IIS Express launch on menu" /></p>
<ul>
<li>
<p><code>IISExpress</code> : Launches <code>IIS Express</code>.</p>
</li>
<li>
<p><code>IIS</code> : No web server launched. <code>IIS</code> is expected to be available.</p>
</li>
<li>
<p><code>Project</code> : Launches Kestrel.</p>
</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/environments/_static/launch-profiles.png?view=aspnetcore-8.0" alt="Project Properties Setting Environment variables!" title="Project Properties Setting Environment variables" /></p>
<pre><code class="language-json">{
  &quot;iisSettings&quot;: {
    &quot;windowsAuthentication&quot;: false,
    &quot;anonymousAuthentication&quot;: true,
    &quot;iisExpress&quot;: {
      &quot;applicationUrl&quot;: &quot;http://localhost:59481&quot;,
      &quot;sslPort&quot;: 44308
    }
  },
  &quot;profiles&quot;: {
    &quot;EnvironmentsSample&quot;: {
      &quot;commandName&quot;: &quot;Project&quot;,
      &quot;dotnetRunMessages&quot;: true,
      &quot;launchBrowser&quot;: true,
      &quot;applicationUrl&quot;: &quot;https://localhost:7152;http://localhost:5105&quot;,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Development&quot;
      }
    },
    &quot;EnvironmentsSample-Staging&quot;: {
      &quot;commandName&quot;: &quot;Project&quot;,
      &quot;dotnetRunMessages&quot;: true,
      &quot;launchBrowser&quot;: true,
      &quot;applicationUrl&quot;: &quot;https://localhost:7152;http://localhost:5105&quot;,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Staging&quot;,
        &quot;ASPNETCORE_DETAILEDERRORS&quot;: &quot;1&quot;,
        &quot;ASPNETCORE_SHUTDOWNTIMEOUTSECONDS&quot;: &quot;3&quot;
      }
    },
    &quot;EnvironmentsSample-Production&quot;: {
      &quot;commandName&quot;: &quot;Project&quot;,
      &quot;dotnetRunMessages&quot;: true,
      &quot;launchBrowser&quot;: true,
      &quot;applicationUrl&quot;: &quot;https://localhost:7152;http://localhost:5105&quot;,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Production&quot;
      }
    },
    &quot;IIS Express&quot;: {
      &quot;commandName&quot;: &quot;IISExpress&quot;,
      &quot;launchBrowser&quot;: true,
      &quot;environmentVariables&quot;: {
        &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Development&quot;
      }
    }
  }
}
</code></pre>
<ul>
<li>
<p>From the Visual Studio UI.</p>
</li>
<li>
<p>Using the <code>dotnet run</code> CLI command with the <code>--launch-profile</code> option set to the profile's name. This approach only supports Kestrel profiles.
dotnet run <code>--launch-profile</code> &quot;EnvironmentsSample&quot;</p>
</li>
</ul>
<pre><code class="language-dotnetcli">dotnet run --launch-profile &quot;EnvironmentsSample&quot;
</code></pre>
<blockquote>
<p class='warning'>Warning
launchSettings.json shouldn't store secrets. The Secret Manager tool can be used to store secrets for local development.</p>
</blockquote>
<pre><code class="language-json">{
    &quot;version&quot;: &quot;0.2.0&quot;,
    &quot;configurations&quot;: [
        {
            &quot;name&quot;: &quot;.NET Core Launch (web)&quot;,
            &quot;type&quot;: &quot;coreclr&quot;,
            // Configuration ommitted for brevity.
            &quot;env&quot;: {
                &quot;ASPNETCORE_ENVIRONMENT&quot;: &quot;Development&quot;,
                &quot;ASPNETCORE_URLS&quot;: &quot;https://localhost:5001&quot;,
                &quot;ASPNETCORE_DETAILEDERRORS&quot;: &quot;1&quot;,
                &quot;ASPNETCORE_SHUTDOWNTIMEOUTSECONDS&quot;: &quot;3&quot;
            },
            // Configuration ommitted for brevity.
</code></pre>
<h3><a href="#production" aria-hidden="true" class="anchor" id="production"></a><code>Production</code></h3>
<ul>
<li>
<p>Caching.</p>
</li>
<li>
<p>Client-side resources are bundled, minified, and potentially served from a CDN.</p>
</li>
<li>
<p>Diagnostic error pages disabled.</p>
</li>
<li>
<p>Friendly error pages enabled.</p>
</li>
<li>
<p><code>Production</code> logging and monitoring enabled. For example, using Application Insights.</p>
</li>
</ul>
<h2><a href="#set-the-environment-by-setting-an-environment-variable" aria-hidden="true" class="anchor" id="set-the-environment-by-setting-an-environment-variable"></a>Set the environment by setting an environment variable</h2>
<h3><a href="#azure-app-service" aria-hidden="true" class="anchor" id="azure-app-service"></a>Azure App Service</h3>
<ul>
<li>
<p>Select the app from the App Services page.</p>
</li>
<li>
<p>In the Settings group, select Environment variables.</p>
</li>
<li>
<p>In the App settings tab, select + Add.</p>
</li>
<li>
<p>In the Add/Edit application setting window, provide <code>ASPNETCORE_ENVIRONMENT</code> for the Name. For Value, provide the environment (for example, <code>Staging</code>).</p>
</li>
<li>
<p>Select the Deployment slot setting checkbox if you wish the environment setting to remain with the current slot when deployment slots are swapped. For more information, see Set up staging environments in Azure App Service in the Azure documentation.</p>
</li>
<li>
<p>Select OK to close the Add/Edit application setting dialog.</p>
</li>
<li>
<p>Select Save at the top of the Configuration page.</p>
</li>
</ul>
<h3><a href="#windows---set-environment-variable-for-a-process" aria-hidden="true" class="anchor" id="windows---set-environment-variable-for-a-process"></a>Windows - Set environment variable for a process</h3>
<pre><code class="language-console">set ASPNETCORE_ENVIRONMENT=Staging
dotnet run --no-launch-profile
</code></pre>
<pre><code class="language-powershell">$Env:ASPNETCORE_ENVIRONMENT = &quot;Staging&quot;
dotnet run --no-launch-profile
</code></pre>
<h3><a href="#windows---set-environment-variable-globally" aria-hidden="true" class="anchor" id="windows---set-environment-variable-globally"></a>Windows - Set environment variable globally</h3>
<ul>
<li>Open the Control Panel &gt; System &gt; Advanced system settings and add or edit the <code>ASPNETCORE_ENVIRONMENT</code> value:</li>
</ul>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/environments/_static/systemsetting_environment.png?view=aspnetcore-8.0" alt="System Advanced Properties!" title="System Advanced Properties" /></p>
<p><img src="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/environments/_static/windows_aspnetcore_environment.png?view=aspnetcore-8.0" alt="ASPNET Core Environment Variable!" title="ASPNET Core Environment Variable" /></p>
<ul>
<li>
<p>Open an administrative command prompt and use the <code>setx</code> command or open an administrative PowerShell command prompt and use <code>[Environment]::SetEnvironmentVariable</code>:</p>
<ul>
<li><code>setx</code> <code>ASPNETCORE_ENVIRONMENT</code> <code>Staging</code> <code>/M</code></li>
</ul>
</li>
</ul>
<p>The <code>/M</code> switch sets the environment variable at the system level. If the <code>/M</code> switch isn't used, the environment variable is set for the user account.</p>
<pre><code class="language-console">setx ASPNETCORE_ENVIRONMENT Staging /M
</code></pre>
<ul>
<li><code>[Environment]::SetEnvironmentVariable</code>(&quot;ASPNETCORE_ENVIRONMENT&quot;, &quot;Staging&quot;, &quot;Machine&quot;)</li>
</ul>
<p>The <code>Machine</code> option sets the environment variable at the system level. If the option value is changed to <code>User</code>, the environment variable is set for the user account.</p>
<pre><code class="language-powershell">[Environment]::SetEnvironmentVariable(&quot;ASPNETCORE_ENVIRONMENT&quot;, &quot;Staging&quot;, &quot;Machine&quot;)
</code></pre>
<h3><a href="#windows---use-webconfig" aria-hidden="true" class="anchor" id="windows---use-webconfig"></a>Windows - Use <code>web.config</code></h3>
<h3><a href="#windows---iis-deployments" aria-hidden="true" class="anchor" id="windows---iis-deployments"></a>Windows - <code>IIS</code> deployments</h3>
<pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;EnvironmentName&gt;Development&lt;/EnvironmentName&gt;
&lt;/PropertyGroup&gt;
</code></pre>
<ul>
<li>
<p>Execute <code>net stop was /y</code> followed by <code>net start w3svc</code> from a command prompt.</p>
</li>
<li>
<p>Restart the server.</p>
</li>
</ul>
<h3><a href="#macos" aria-hidden="true" class="anchor" id="macos"></a>macOS</h3>
<pre><code class="language-bash">ASPNETCORE_ENVIRONMENT=Staging dotnet run
</code></pre>
<pre><code class="language-bash">export ASPNETCORE_ENVIRONMENT=Staging
</code></pre>
<pre><code class="language-bash">export ASPNETCORE_ENVIRONMENT=Staging
</code></pre>
<h3><a href="#linux" aria-hidden="true" class="anchor" id="linux"></a>Linux</h3>
<h2><a href="#set-the-environment-in-code" aria-hidden="true" class="anchor" id="set-the-environment-in-code"></a>Set the environment in code</h2>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    EnvironmentName = Environments.Staging
}); 

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler(&quot;/Error&quot;);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
</code></pre>
<h2><a href="#configuration-by-environment" aria-hidden="true" class="anchor" id="configuration-by-environment"></a>Configuration by environment</h2>
<h2><a href="#configure-services-and-middleware-by-environment" aria-hidden="true" class="anchor" id="configure-services-and-middleware-by-environment"></a>Configure services and middleware by environment</h2>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler(&quot;/Error&quot;);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
</code></pre>
<h2><a href="#additional-resources" aria-hidden="true" class="anchor" id="additional-resources"></a>Additional resources</h2>
<ul>
<li>
<p>View or download sample code (how to download)</p>
</li>
<li>
<p>App startup in ASP.NET Core</p>
</li>
<li>
<p>Configuration in ASP.NET Core</p>
</li>
<li>
<p>ASP.NET Core Blazor environments</p>
</li>
</ul>
<p>Ref: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-8.0">Use multiple environments in ASP.NET Core</a></p>
 <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/Summary.html'>Summary</a><a class='topic-tag' href='/tags/AspNetCore.html'>AspNetCore</a></div>
      </div>
    </div>
  </body>
</html>
