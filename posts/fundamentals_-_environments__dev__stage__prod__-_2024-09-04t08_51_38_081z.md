---
title: Fundamentals - Environments (dev, stage, prod)
published: true
date: 2024-09-04 08:51:38
tags: Summary, AspNetCore
description: 
image:
---

## In this article

## Environments

 - ```DOTNET_ENVIRONMENT```

 - ```ASPNETCORE_ENVIRONMENT``` when the ```WebApplication.CreateBuilder``` method is called. The default ASP.NET Core web app templates call ```WebApplication.CreateBuilder```. The ```DOTNET_ENVIRONMENT``` value overrides ```ASPNETCORE_ENVIRONMENT``` when ```WebApplicationBuilder``` is used. For other hosts, such as ```ConfigureWebHostDefaults``` and ```WebHost.CreateDefaultBuilder```, ```ASPNETCORE_ENVIRONMENT``` has higher precedence.

 - ```Development```: The ```launchSettings.json``` file sets ```ASPNETCORE_ENVIRONMENT``` to ```Development``` on the local machine.

 - ```Staging```

 - ```Production```: The default if ```DOTNET_ENVIRONMENT``` and ```ASPNETCORE_ENVIRONMENT``` have not been set.

 - Is similar to the code generated by the ASP.NET Core templates.

 - Enables the Developer Exception Page when ```ASPNETCORE_ENVIRONMENT``` is set to ```Development```. This is done automatically by the ```WebApplication.CreateBuilder``` method.

 - Calls UseExceptionHandler when the value of ```ASPNETCORE_ENVIRONMENT``` is anything other than ```Development```.

 - Provides an IWebHostEnvironment instance in the Environment property of ```WebApplication```.

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
```

```cshtml
<environment include="Development">
    <div>Environment is Development</div>
</environment>
<environment exclude="Development">
    <div>Environment is NOT Development</div>
</environment>
<environment include="Staging,Development,Staging_2">
    <div>Environment is: Staging, Development or Staging_2</div>
</environment>
```

### Create ```EnvironmentsSample```

```bash
dotnet new webapp -o EnvironmentsSample
cd EnvironmentsSample
dotnet run --verbosity normal
```

```bash
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7152
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5105
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Path\To\EnvironmentsSample
```

### Set environment on the command line

```dotnetcli
dotnet run --environment Production
```

```bash
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7262
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5005
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Path\To\EnvironmentsSample
```

### ```Development``` and ```launchSettings.json```

 - Is only used on the local development machine.

 - Is not deployed.

 - Contains profile settings.

```json
{
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:59481",
      "sslPort": 44308
    }
  },
  "profiles": {
    "EnvironmentsSample": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:7152;http://localhost:5105",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

 - ```EnvironmentsSample```: The profile name is the project name. As the first profile listed, this profile is used by default. The "commandName" key has the value "Project", therefore, the Kestrel web server is launched.

 - ```IIS Express```: The "commandName" key has the value "IISExpress", therefore, ```IISExpress``` is the web server.

![IIS Express launch on menu!](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/_static/iisx2.png?view=aspnetcore-8.0 "IIS Express launch on menu")

 - ```IISExpress``` : Launches ```IIS Express```.

 - ```IIS``` : No web server launched. ```IIS``` is expected to be available.

 - ```Project``` : Launches Kestrel.

![Project Properties Setting Environment variables!](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/_static/launch-profiles.png?view=aspnetcore-8.0 "Project Properties Setting Environment variables")

```json
{
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:59481",
      "sslPort": 44308
    }
  },
  "profiles": {
    "EnvironmentsSample": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:7152;http://localhost:5105",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "EnvironmentsSample-Staging": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:7152;http://localhost:5105",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Staging",
        "ASPNETCORE_DETAILEDERRORS": "1",
        "ASPNETCORE_SHUTDOWNTIMEOUTSECONDS": "3"
      }
    },
    "EnvironmentsSample-Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:7152;http://localhost:5105",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

 - From the Visual Studio UI.

 - Using the ```dotnet run``` CLI command with the ```--launch-profile``` option set to the profile's name. This approach only supports Kestrel profiles.
dotnet run ```--launch-profile``` "EnvironmentsSample"

```dotnetcli
dotnet run --launch-profile "EnvironmentsSample"
```

> Warning
launchSettings.json shouldn't store secrets. The Secret Manager tool can be used to store secrets for local development.

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": ".NET Core Launch (web)",
            "type": "coreclr",
            // Configuration ommitted for brevity.
            "env": {
                "ASPNETCORE_ENVIRONMENT": "Development",
                "ASPNETCORE_URLS": "https://localhost:5001",
                "ASPNETCORE_DETAILEDERRORS": "1",
                "ASPNETCORE_SHUTDOWNTIMEOUTSECONDS": "3"
            },
            // Configuration ommitted for brevity.
```

### ```Production```

 - Caching.

 - Client-side resources are bundled, minified, and potentially served from a CDN.

 - Diagnostic error pages disabled.

 - Friendly error pages enabled.

 - ```Production``` logging and monitoring enabled. For example, using Application Insights.

## Set the environment by setting an environment variable

### Azure App Service

 - Select the app from the App Services page.

 - In the Settings group, select Environment variables.

 - In the App settings tab, select + Add.

 - In the Add/Edit application setting window, provide ```ASPNETCORE_ENVIRONMENT``` for the Name. For Value, provide the environment (for example, ```Staging```).

 - Select the Deployment slot setting checkbox if you wish the environment setting to remain with the current slot when deployment slots are swapped. For more information, see Set up staging environments in Azure App Service in the Azure documentation.

 - Select OK to close the Add/Edit application setting dialog.

 - Select Save at the top of the Configuration page.

### Windows - Set environment variable for a process

```console
set ASPNETCORE_ENVIRONMENT=Staging
dotnet run --no-launch-profile
```

```powershell
$Env:ASPNETCORE_ENVIRONMENT = "Staging"
dotnet run --no-launch-profile
```

### Windows - Set environment variable globally

 - Open the Control Panel > System > Advanced system settings and add or edit the ```ASPNETCORE_ENVIRONMENT``` value:

![System Advanced Properties!](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/_static/systemsetting_environment.png?view=aspnetcore-8.0 "System Advanced Properties")

![ASPNET Core Environment Variable!](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments/_static/windows_aspnetcore_environment.png?view=aspnetcore-8.0 "ASPNET Core Environment Variable")

 - Open an administrative command prompt and use the ```setx``` command or open an administrative PowerShell command prompt and use ```[Environment]::SetEnvironmentVariable```:

   - ```setx``` ```ASPNETCORE_ENVIRONMENT``` ```Staging``` ```/M```

The ```/M``` switch sets the environment variable at the system level. If the ```/M``` switch isn't used, the environment variable is set for the user account.

```console
setx ASPNETCORE_ENVIRONMENT Staging /M
```

   - ```[Environment]::SetEnvironmentVariable```("ASPNETCORE_ENVIRONMENT", "Staging", "Machine")

The ```Machine``` option sets the environment variable at the system level. If the option value is changed to ```User```, the environment variable is set for the user account.

```powershell
[Environment]::SetEnvironmentVariable("ASPNETCORE_ENVIRONMENT", "Staging", "Machine")
```

### Windows - Use ```web.config```

### Windows - ```IIS``` deployments

```xml
<PropertyGroup>
  <EnvironmentName>Development</EnvironmentName>
</PropertyGroup>
```

 - Execute ```net stop was /y``` followed by ```net start w3svc``` from a command prompt.

 - Restart the server.

### macOS

```bash
ASPNETCORE_ENVIRONMENT=Staging dotnet run
```

```bash
export ASPNETCORE_ENVIRONMENT=Staging
```

```bash
export ASPNETCORE_ENVIRONMENT=Staging
```

### Linux

## Set the environment in code

```csharp
var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    EnvironmentName = Environments.Staging
}); 

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
```

## Configuration by environment

## Configure services and middleware by environment

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorPages();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapRazorPages();

app.Run();
```

## Additional resources

 - View or download sample code (how to download)

 - App startup in ASP.NET Core

 - Configuration in ASP.NET Core

 - ASP.NET Core Blazor environments

Ref: [Use multiple environments in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/environments?view=aspnetcore-8.0)